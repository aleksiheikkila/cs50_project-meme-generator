{% extends "layout.html" %}

{% block title %}
    Testing the user inputs
{% endblock %}

{% block main %}
    <h3>Meme generator</h3>


    <!-- 
        1. File upload from local
        2. text field for url

        3. upper text
        4. lower text

        5. formatting. Color picker, transparency [0-100% ?]


        WOuld be nice... upload image, show preview
        Select bbox for text on the preview img.


        Step 1: select base image

    -->
    <div class="columncontainer m-1">

        <div class="column">
            <h5>STEP 1: Select base image</h5>
            <p>Either give URL to an image or a local file:</p>
            <div>
                <form action="/make_meme" method="POST" enctype="multipart/form-data" id="inputform">
                    <div class="form-group">
                        <!-- <label for="base-img-url">URL:</label> -->
                        <input autocomplete="off" autofocus class="form-control" name="img_url" 
                            id="base-img-url" placeholder="URL..." type="text">
                        <button class="btn btn-primary" id="btn-fetch-img-from-url" type="button"
                                onclick="getImgFromURL(event)">Fetch</button>

                        <br>
                        <div style="margin-top: 10px;">
                            <label for="img_file" class="btn custom-file-upload">
                                OR, select a local file</label>
                            <input name="img_file" id="img_file" type="file" accept="image/*" 
                                    onchange="loadFile(event)">

                        </div>
                    </div>

                    <br>
                    <h5>STEP 2: Setup meme text</h5>
                        <div class="form-group">
                            <div> 
                                <label class="labelgroup1" for="upper_text">Upper text:</label>
                                <textarea rows="1" cols="30" id="upper_text" name="upper_text"></textarea>
                            </div>
                            <div>
                                <label class="labelgroup1" for="lower_text">Lower text:</label>
                                <!--<input type="text" id="lower_text" name="lower_text">-->
                                <textarea rows="1" cols="30" id="lower_text" name="lower_text"></textarea>
                            </div>

                            <div> <!-- This always converts the color to RGB hex -->
                                <label class="labelgroup1" for="upper_text_color">Color:</label>
                                <input type="color" id="upper_text_color" name="upper_text_color" value="#e66465">
                            </div>
                            
                            
                            <div class="slidecontainer">
                                <label for="transparency">Transparency (current: <span id="transparency_val"></span>)</label>
                                <span><input type="range" min="1" max="99" value="50" id="transparency_slider" name="transparency" /></span> 
                            </div>
                            
                        </div>
                        <button class="btn btn-primary" type="submit">Generate</button>
                </form>
                
            </div>
        </div>

        <div class="column">
            <h5>Original image</h5>
            <div class="base-img-container">
                <img id="base-image" style="width:100%;"/>
            </div>
        </div>


        <!-- Show the processed output image-->
        <div class="column">
            <h5>Modified image</h5>
            <div id="processed-img-div">
                <img id="processed-img">
                <br>
                <button class="btn btn-primary" id="download-meme-btn" style="display:none; margin-top:5px" onclick="download_meme()">Download</button>
            </div>
        </div>   

    </div>

    <script>
        var slider = document.getElementById("transparency_slider");
        var output = document.getElementById("transparency_val");
        output.innerHTML = slider.value;
        
        slider.oninput = function() {
          if (this.value < 10) {
            output.innerHTML = "0" + this.value;
          }
          else {
            output.innerHTML = this.value;
          }
          console.log(output.innerHTML)
        }

        function empty_processed() {
            // Removes processed img and hides the download button
            document.getElementById ('processed-img').src = "";
            document.getElementById('download-meme-btn').style.display = "none";
        }

        // Upload image from local and show
        var loadFile = function(event) {
            var image = document.getElementById('base-image');
            image.style.width = "20%";
            image.src = "static/ajax-loader.gif"
            document.getElementById('base-img-url').value = "";

            image.src = URL.createObjectURL(event.target.files[0]);
            image.style.width = "100%";
            empty_processed()
        };

        // Get image from url
        var getImgFromURL = function(event) {
            var image = document.getElementById('base-image');
            image.src = "static/ajax-loader.gif"
            image.style.width = "20%";
            var url = document.getElementById('base-img-url').value;
            if (url.length > 0) {
                image.src = url;
                image.style.width = "100%";
                document.getElementById('img_file').value = "";
                empty_processed()
            }
        };

        // Hijack input submit
        $('form#inputform').submit(function(event) {
            // Stop form from submitting normally
            event.preventDefault();
            console.log(event)

            // Show spinner gif and hide the download button
            var proc_image = document.getElementById('processed-img')
            //proc_image.css("width", "");
            proc_image.style.width = "20%";
            //proc_image.style.     // = "10%";
            proc_image.src = "static/ajax-loader.gif"
            document.getElementById('download-meme-btn').style.display = "none";

    
            var formData = new FormData(this);
            // Get some values from elements on the page:
            var $form = $( this )
            url = $form.attr( "action" );
            console.log(url)

            var posting = $.ajax({
                    url: url,
                    type: 'POST',
                    data: formData,
                    cache: false,
                    contentType: false,
                    processData: false
                });

            //console.log(posting)


            // Put the results in a div
            posting.done(function( data ) {
                var proc_image = document.getElementById('processed-img')
                proc_image.src = data;
                proc_image.style.width = "100%";
                //console.log("proc_image.src")
                //console.log(proc_image.src)
                //console.log(proc_image.src.length)
                if (proc_image.src.length > 100 ) {
                    document.getElementById('download-meme-btn').style.display = "block";
                }
            });
        });

        function download_meme() {
            var proc_image = document.getElementById('processed-img')
            var btn = document.getElementById('download-meme-btn')
            //var gh = 

            var a  = document.createElement('a');
            a.href = proc_image.src;
            a.download = 'meme_image.png';
            a.click() 
        }

    </script>

    <!-- Check 
        https://www.webtrickshome.com/forum/how-to-display-uploaded-image-in-html-using-javascript 
    
        https://stackoverflow.com/questions/10906734/how-to-upload-image-into-html5-canvas

        Dunno how to create drag boxes for defining the bbox.
        Could it work if the user can define the 4 corner coordinates, and the bbox would
        be updated on top of the preview image to show where the text will be put into?
    -->
{% endblock %}
